# 规则：数学公式渲染要求 (Kramdown + MathJax 环境)

**目标读者：** AI 助手

**适用范围：** 在此项目中，为 Jekyll 网站生成或修改包含数学公式的 Markdown 文件。

**背景：**

本项目使用 Jekyll + Kramdown + MathJax。虽然 Kramdown 配置了 `math_engine: mathjax`，但在处理 Markdown 到 HTML 的转换时，它**仍有可能错误地解析**数学块（`$...$` 或 `$$...$$`）内的某些字符，特别是：

*   单竖线 `|`
*   星号 `*`
*   下划线 `_` (即使是合法的 LaTeX 下标)

这种错误解析会破坏原始 LaTeX 代码，导致在最终网页上 MathJax 无法正确渲染公式，即使 Markdown 预览正常。

**强制要求与解决方案：**

为了确保部署后数学公式的正确渲染，在生成或编辑包含数学公式的 Markdown 内容时，**必须**遵守以下规则，按优先级顺序尝试：

1.  **首选方案：在 LaTeX 内部使用明确命令避免歧义和保证格式**
    *   **禁止在数学公式内部直接使用单竖线 `|`。**
        *   **必须使用 `\vert` 命令** 来表示普通单竖线（例如：条件概率 $P(A \vert B)$）。
        *   如果需要表示具有"关系"含义的竖线，可以使用 `\mid`。
        *   **不要使用 `\|`**，它会被 MathJax 渲染为双竖线 `||`。
    *   **对于下标和上标：推荐始终使用花括号 `{}` 包裹**，即使是单个字符。例如：将 `_n` 写为 `_{n}`，将 `^2` 写为 `^{2}`。这可以减少 Kramdown 误判的概率。
    *   **对于公式内部的普通文本单词：必须使用 `\text{...}` 包裹。** 例如，应该写 `$\text{Loss}_\text{novel}$` 而不是 `$Loss_{novel}$`，以确保 "Loss", "novel" 使用正体文本字体而不是数学斜体，并保证正确的间距。
    *   **谨慎处理其他特殊字符：** 对于星号 `*` 等，如果它们在数学公式中的用法可能与 Markdown 的强调或其他语法冲突，并且导致渲染问题，**优先使用对应的 LaTeX 命令**（例如用 `\times` 表示乘法）来消除歧义。

2.  **最终解决方案：当上述方法无效时，使用 Kramdown 的 `{::nomarkdown}` 块**
    *   如果即使使用了明确的 LaTeX 命令，Kramdown 仍然错误地解析并破坏了数学公式（特别是对于包含下划线 `_` 或其他复杂结构的公式），最后的手段是**将整个数学公式（包括 `$...$` 或 `$$...$$` 定界符）包裹在 `{::nomarkdown} ... {:/nomarkdown}` 块中**。
    *   **示例：**
        ```markdown
        {::nomarkdown}
        $$ \bar{X}_{n} = \frac{1}{n}\sum_{i=1}^{n} X_{i} $$
        {:/nomarkdown}
        ```
    *   这个方法会强制 Kramdown 完全不处理块内的任何内容，将其原样输出到 HTML，从而确保 MathJax 能接收到未被破坏的 LaTeX 代码。

**摘要：**
*   首选通过在 LaTeX 内部使用明确命令 (`\vert`, `_{...}`, `\text{...}` 等) 来解决。
*   如果 Kramdown 仍然干扰，则使用 `{::nomarkdown}` 包裹整个数学公式作为最终手段。


